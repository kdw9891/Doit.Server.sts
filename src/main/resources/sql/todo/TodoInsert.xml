<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="TodoInsert">
	
	<!-- Todo 사용자별 해당 일자 할일 순서 최대값 추출 쿼리 -->
	<select id="SelectTodoOrder" resultType="HashMap" parameterType="HashMap">
  		SELECT 
    		IFNULL(MAX(task_order), 0) AS max_order
		FROM
		    DOIT.tb_todolist
		WHERE
	    	user_id = #{user_id}
	    	AND task_date = #{task_date}
	</select>

	<!-- Todo 완료 여부 참고 : (0: 미완료, 1: 완료) -->
	<insert id="InsertTodo" parameterType="HashMap">
		INSERT INTO DOIT.tb_todolist (
    		user_id
    	,   task_title
    	,   task_date
    	,   task_order
    	,   is_completed
    	,   created_dt
		) VALUES (
    		#{user_id}
    	,   #{task_title}
    	,    CURRENT_DATE()
    	,
    	(
        	SELECT
        		new_task_order
        	FROM
        		(
            		SELECT
            			IFNULL(MAX(task_order), 0) + 1 AS new_task_order
            		FROM
            			DOIT.tb_todolist
            		WHERE
            			user_id = #{user_id}
            			AND task_date = #{task_date}
        		) AS subquery
    	),
    		0
    	,	CURRENT_TIMESTAMP()
		);
	</insert>

	<!-- Todo Clear 완료 처리 쿼리 -->
	<update id="UpdateTodoClear" parameterType="HashMap">
    	UPDATE tb_todolist
    	SET is_completed = 1,
            updated_dt = CURRENT_TIMESTAMP()
        WHERE
        	user_id = #{user_id}
        	AND task_date = #{task_date}
        	AND task_id = #{task_id}
	</update>
  
  
</mapper>